# いろいろな検定

## t検定

### やれること

* 母平均の区間推定 (基本的過ぎるので割愛)
* 母比率の検定
* 2標本t検定 (等分散の場合)

### 母比率の差の検定

参考：<https://bellcurve.jp/statistics/course/18227.html>

母比率の推定値はサンプル数が多い場合、近似的に$N(p, \frac{p(1-p)}{n})$に従うのであった。正規分布の再生性より、2つのサンプルから得た母比率$\hat{p_1}, \hat{p_2}$の差も正規分布に従う。具体的には以下の通り。

\begin{equation}
\hat{p_1} - \hat{p_2} \sim N\left(p_1 - p_2, \frac{p_1(1-p_1)}{n_1} + \frac{p_2(1-p_2)}{n_2} \right)
\end{equation}

これを元に信頼区間を求めることができる。念の為、標準形も記載しておく。

\begin{equation}
\frac{(\hat{p_1} - \hat{p_2}) - (p_1 - p_2)}{\sqrt{\frac{p_1(1-p_1)}{n_1} + \frac{p_2(1-p_2)}{n_2}}} \sim N(0, 1^2)
\end{equation}

### 2標本t検定 (等分散の場合)

対応がある2標本であれば、単純に差を取って普通のt検定をすればよい。ここでは対応のない2標本t検定について記載する。

2つの母集団から標本をそれぞれ$n_1, n_2$個ずつ抽出する。このとき、以下の統計量が自由度$n_1 + n_2 - 2$のt分布に従うことを利用する。

\begin{equation}
\frac{\overline{x_1}-\overline{x_2}}{s\sqrt{\frac{1}{n_1} + \frac{1}{n_2}}}
\end{equation}

ここで、$s$はプールした分散を表す。具体的には以下の通り。

\begin{equation}
s^2 = \frac{(n_1-1)s_1^2 + (n_2-1)s_2^2}{n_1+n_2-2}
\end{equation}

結局、プールした分散とは自由度を元にした不偏分散の平均のことである。

## $\chi^2$検定

### やれること

* 母分散の区間推定
* 適合度の検定
* 独立性の検定

### 母分散の区間推定

参考：<https://bellcurve.jp/statistics/course/9212.html>

$n$個のサンプルから得られる不偏分散を$s$とするとき、以下の統計量が自由度$n-1$の$\chi^2$分布に従うことを利用する。

\begin{equation}
\frac{(n-1)s^2}{\sigma^2}
\end{equation}

#### なぜこれが$\chi^2$分布に従うのか？

不偏分散$s^2$は以下の式で表される。

\begin{equation}
s^2 = \frac{1}{n-1} \sum_{i=1}^n (X_i - \overline{X})^2
\end{equation}

ここで、両辺に$(n-1)/\sigma^2$を掛けると以下のようになる。

\begin{equation}
\frac{(n-1)s^2}{\sigma^2} = \sum_{i=1}^n \left(\frac{X_i - \overline{X}}{\sigma}\right)^2
\end{equation}

各$i$について$\frac{X_i - \overline{X}}{\sigma}$は標準正規分布に従うから、これは$\chi^2$分布となる。

### 適合度の検定

実測値を$x_i$、適合すると想定する理論値を$t_i$とする。$n$個のサンプルがあるとき、以下の統計量が自由度$n-1$の$\chi^2$分布に従うことを利用する。

\begin{equation}
\sum_{i=1}^n \frac{(x_i-t_i)^2}{t_i}
\end{equation}

#### なぜこれが$\chi^2$分布に従うのか？

これは正確には理論確率$p_i$に対して理論度数を$t_i = np_i$として考えるべきものである。証明は難しいが、$n$が大きくなると中心極限定理によって$\chi^2$分布になるらしい。

#### 過去問に似た例
以下のようなデータがあったとする。

| 月曜 | 火曜 | 水曜 | 木曜 | 金曜
| -------- | -------- | -------- | -------- | -------- |
| 3 | 4 | 2 | 5 | 3 |

これに対して、曜日に対するばらつきがあるかどうかを知りたい。帰無仮説を「曜日に対するばらつきはない」とすると、理論値として各曜日のデータの平均値$\overline{\mu}=3.4$を用いることが考えられる。

すると、検定すべき統計量は以下のようになる。

\begin{equation}
\frac{(3-3.4)^2}{3.4} + \frac{(4-3.4)^2}{3.4} + \frac{(2-3.4)^2}{3.4} + \frac{(5-3.4)^2}{3.4} + \frac{(3-3.4)^2}{3.4}
\end{equation}

### 独立性の検定

参考：<https://bellcurve.jp/statistics/course/9496.html>

2つの情報が独立しているかどうかを調べたいので、2次元のテーブル (分割表) を用意する。$m$行$n$列であるとする。それらに対して「独立ならこういう理論値になるよね」という値を決めて、適合度の検定と同じように統計量を出す。検定の際には$\chi^2$分布の自由度が$(m-1)(n-1)$である点に注意。

理論値の決め方を例を交えて説明する。以下のような分割表があったとする。

| A\B | $B_1$ | $B_2$ | $B_3$ |
| -------- | -------- | -------- | -------- |
| $A_1$ | 3 | 2 | 3 |
| $A_2$ | 5 | 7 | 6 |
| $A_3$ | 4 | 4 | 3 |
| $A_4$ | 2 | 3 | 3 |

やりたいことは、データAとデータBが独立であるかどうかの検定である。帰無仮説を「AとBは独立である」とする。もし独立な場合、以下の式が成立する。

\begin{equation}
P(A_i \cap B_j) = P(A_i)P(B_j)
\end{equation}

例として$P(A_1), P(B_2)$を考える。$A_i, B_j$のデータを$x_{i,j}$とすると、これはそれぞれ以下のように計算できる。

\begin{eqnarray}
P(A_1) &=& \frac{\sum_{j=1}^3 x_{1,j}}{\sum_{i=1}^4 \sum_{j=1}^3 x_{i,j}} \\
&=& \frac{8}{45} \\
&=& 0.177...
\end{eqnarray}

\begin{eqnarray}
P(B_2) &=& \frac{\sum_{i=1}^4 x_{i, 2}}{\sum_{i=1}^4 \sum_{j=1}^3 x_{i,j}} \\
&=& \frac{16}{45} \\
&=& 0.355...
\end{eqnarray}

そのため、$P(A_i \cap B_j)$の理論値は以下のようになる。

\begin{eqnarray}
P(A_1) P(B_2) \simeq 0.063
\end{eqnarray}

これに全体の度数をかければ、度数の理論値が求まる。

\begin{eqnarray}
0.063 \times \sum_{i=1}^4 \sum_{j=1}^3 x_{i,j} \simeq 2.8
\end{eqnarray}

## $F$検定

### 基本事項

確率変数$U, V$がそれぞれ自由度$k_1, k_2$の$\chi^2$分布に従っており、かつ互いに独立であるとする。このとき、以下の統計量が従う分布を自由度$(k_1, k_2)$の$F$分布と呼ぶ。

\begin{equation}
\frac{U/k_1}{V/k_2}
\end{equation}

### やれること

* 等分散性の検定
* 一元配置分散分析

### 等分散性の検定

2つの母集団からサンプルをそれぞれ$m$個および$n$個抜き出す。抜き出したサンプルの不偏分散をそれぞれ$s_1, s_2$とする。もし2つのサンプルの母分散が等しい場合、以下の統計量が自由度$(m-1, n-1)$の$F$分布に従うことを利用する。

\begin{equation}
\frac{s_1^2}{s_2^2}
\end{equation}

ただし、$s_1, s_2$のうち大きい方を分子にする。上の式の場合は$s_2 \le s_1$である。なぜこうするのかというと、多分だがF分布のうち左の裾野は無視して、右の裾野だけで検定ができるようにするためだと思われる。両側検定であっても、片方だけ調べれば良くなるので手間が少ない。

あとは帰無仮説を「2つのサンプルの分散は等しい」として検定をすればよい。

### 一元配置分散分析

2標本t検定により2標本の平均値の差を検定することができたが、3群以上のデータを検定などを行えるのが分散分析。一元配置分散分析の流れを例を交えて説明する。

例に使用するデータは以下。

| データ1 | データ2 | データ3 |
| -------- | -------- | -------- |
| 2     | 5     | 3     |
| 3     | 4     | 1     |
| 4     | 7     | 4     |
| 6     | 4     | 3     |

データ$i$の$j$個目のデータを$x_{i,j}$と書く。帰無仮説は「データ1, 2, 3の母平均は全て等しい」とする。

1. まず、データ全体の平均値と各水準の平均値をそれぞれ求める。

* データ全体の平均値：3.833...
* データ1の平均：3.75
* データ2の平均：5
* データ3の平均：2.75

それぞれ式で書くと以下の通り。

\begin{equation}
\overline{x} = \frac{1}{12} \sum_{i=1}^3 \sum_{j=1}^4 x_{i, j}
\end{equation}

\begin{equation}
\overline{x_i} = \frac{1}{4} \sum_{j=1}^4  x_{i, j}
\end{equation}

ただし、$\overline{x_i}$はデータ$i$の平均を表す。

2. 各データと$\overline{x}$の差分2乗和を求める

\begin{equation}
\sum_{i=1}^3 \sum_{j=1}^4 \left(x_{i, j} - \overline{x} \right)^2 = 29.66...
\end{equation}

3. $\overline{x_i}$と$\overline{x}$の差分2乗和を求め、さらにそれらを足し合わせる

\begin{equation}
\sum_{i=1}^3 4 \left(\overline{x_{i}} - \overline{x} \right)^2 = 10.16...
\end{equation}

おまじない的だが、データの個数 (今回だと4) を掛ける必要がある。

4. 誤差の平方和を求める

手順2, 3で求めた差分和の差を求める。
29.66... - 10.16... = 19.5

直接計算するなら、以下のようになる。

\begin{equation}
\sum_{i=1}^3 \sum_{j=1}^4 \left(x_{i, j} - \overline{x_i} \right)^2
\end{equation}

手順2は飛ばして、最初からこれを計算してもよい。

4. 自由度を求める

* 全体の自由度：データ数-1となる。今回のケースだと11。
* 要因の自由度：水準の個数-1となる。今回のケースだと2。
* 残差の自由度：全体-要因。今回のケースだと9。

5. 差分2乗和を自由度で割る

* 要因：5.083...
* 残差：2.166...

このようにして得られた値を平均平方と呼ぶ。

6. 要因と残差の平方平均の比を求める

\begin{equation}
\frac{5.083}{2.167} \simeq 2.35
\end{equation}

必ず要因の平均平方を分子にすること。

7. F検定を行う。

F分布の自由度は要因・残差の自由度から(2, 9)と分かるので、これを元にF検定を行えばよい。

#### おまけ

水準数が2の場合は2標本t検定でも計算ができる。その場合、統計量の間に$F=t^2$という関係が生まれる。もっというと、$t$が自由度$n$のt分布に従うとき、$t^2$は自由度$(1, n)$のF分布に従う。

### F分布に従う確率変数の逆数

確率変数$X$が自由度$(m, n)$のF分布に従うとする。このとき、$\frac{1}{X}$は自由度$(n, m)$のF分布に従う。

例えば、自由度(20, 40)のF分布の上側2.5%点は2.068であるが、下側2.5%は付表から分からない。しかし、これは自由度(40, 20)のF分布の上側2.5%点の逆数として1/2.287のように計算できる。

ちょっと分かりにくいので式でも書いておく。

\begin{eqnarray}
P(X < F_{0.975} (20, 40)) &=& P\left(\frac{1}{X} > \frac{1}{F_{0.975} (20, 40)} \right) \\
&=& P\left(\frac{1}{X} > F_{0.025} (40, 20) \right)
\end{eqnarray}

2つ目の等式がいまいち納得感がないが、こうなるらしい。

## 母相関係数の信頼区間

参考: <https://bellcurve.jp/statistics/course/9591.html>

標本から計算した相関係数$r$、及び母相関係数$\rho$をそれぞれ以下の式で変換。これをフィッシャーのz変換と呼ぶ。

\begin{eqnarray}
z &=& \frac{1}{2} \log{\frac{1+r}{1-r}} \\
\zeta &=& \frac{1}{2} \log{\frac{1+\rho}{1-\rho}}
\end{eqnarray}

サンプルサイズ$n$が大きいとき、$z$が$N\left(\zeta, \frac{1}{n-3} \right)$に従うことを利用する。
